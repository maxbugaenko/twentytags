<?
    $this->headTitle("TwentyTags - ".$this->entity->title);
    $this->headMeta()->appendName('keywords', $this->escape($this->entity->title));
    $this->headMeta()->appendName('description', $this->escape("News about ".$this->entity->title));
    $this->headAnything()->addHtml('<meta property="og:title" content="'.$this->escape($this->entity->title).'">');
    $this->headAnything()->addHtml('<meta property="og:description" content="'.$this->escape($this->entity->description).'">');
    $this->headAnything()->addHtml('<meta property="og:image" content="'.$this->staticFile("images/entities/".$this->entity->picture).'">');
?>
<?
require_once('Model/Facebook/facebook.php');
$config = array(
    'appId' => '706201236078444',
    'secret' => 'fabe992657dcffefd59099502cdf0ce9',
    'allowSignedRequest' => false // optional but should be set to false for non-canvas apps
);
$facebook = new Facebook($config);
?>

<?if ($this->entity->alerts == 0):?>
    <div class="message-container">
        <div>
            <img src="<?=$this->staticFile("images/entities/".$this->entity->picture)?>">
        </div>
        <div>
            <p class="margins">
                No news yet. We've got to wait a little. Either follow this tag or get back later
            </p>
            <a class="big" href="<?=$this->url(array(), "browse", false)?>">browse other tags</a>
        </div>
    </div>
<?else:?>

<div class="toTop">
    <i id="to-top-button" class="btn-icon fa fa-angle-double-up"></i>
</div>
<article class="container  padding-large" style="border-bottom: 1px solid lightgray">
    <div class="span7">
        <h1><?=$this->entity->title?></h1>
        <p class="margins">
            <?=$this->entity->description?>
        </p>
        <?if (!Model_User::isLoggedIn()): ?>
            <?$isLogged = "user-not-logged";?>
            <div class="login-urls" id="login-url-<?=$this->entity?>">
                <?
                $loginUrl = $facebook->getLoginUrl(array(
                    "redirect_uri" => WEBSITE_URL.$this->url(array("action"=>"login", "follow"=>$this->entity), "login", false)
                ));
                echo $loginUrl;
                ?>
            </div>

        <?endif?>
        <? $isSaved = Model_Entity::isSaved($this->entity);?>
        <button id="follow-<?=$this->entity?>" class="margins to-follow-button <?=$isLogged?> btn-large <?=$isSaved ? " followed":""?>">
            <?=$isSaved ? "Unfollow" : "Follow"?>
        </button>
    </div>
    <div class="span3">
    </div>
    <div class="span2">
        <p class="margins">
            <a target="_blank" onclick="return !window.open(this.href, 'Facebook', 'width=640,height=300')"
               href="http://www.facebook.com/sharer/sharer.php?u=http://twentytags.com<?=$this->url(array("id"=>$this->entity, Model_Static_Functions::dashString($this->entity->title)=>""), "entity", false)?>">
                <i class="facebook fa fa-facebook-square"></i>
            </a>
            <a target="_blank" onclick="return !window.open(this.href, 'Twitter', 'width=640,height=300')"
               href="https://twitter.com/share">
                <i class="twitter fa fa-twitter-square"></i>
            </a>
            <a target="_blank" onclick="return !window.open(this.href, 'Google+', 'width=640,height=300')"
               href="https://plus.google.com/share?url=http://twentytags.com<?=$this->url(array("id"=>$this->entity, Model_Static_Functions::dashString($this->entity->title)=>""), "entity", false)?>">
                <i class="google fa fa-google-plus-square"></i>
            </a>
        </p>
    </div>
</article>
<div class="padding-large <?if (count($this->alerts) == 0) { echo "add-no-alerts-margin"; }?>">
    <?=$this->partial("partials/morealerts.phtml", array("alerts"=>$this->alerts, "mode"=> "entity"));?>
</div>
<?endif?>

<script>
    var now = new Date().getTime();
    $(document).scroll(function () {
        var y = $(this).scrollTop();
        if (y > 800) {
            $('.toTop').fadeIn();
        } else {
            $('.toTop').fadeOut();
        }
        if (y > $(document).height() - $(window).height()) {
            if (new Date().getTime() - now > 1000) {
                var offset = $(window).data("offset");
                var url = "<?=$this->url(array('controller' => 'index', 'action' => 'morealerts', "mode" => "entity"), 'default', true)?>";
                var loadUrl = url + '/offset/' + offset;
                loadMore(
                    $("article:last-child"),
                    loadUrl
                );
                now = new Date().getTime();
            }
        }
    });
    $(document).ready (function() {
        $(window).data("offset", "20");
        $("#to-top-button").click(function() {
            $('html, body').animate({ scrollTop: 0 }, 'slow');
        });
    });
    $(".to-follow-button").FollowEntity();
</script>
