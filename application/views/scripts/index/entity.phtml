<?
    $this->headTitle("TwentyTags - ".$this->entity->title);
    $this->headMeta()->appendName('keywords', $this->escape($this->entity->title));
    $this->headMeta()->appendName('description', $this->escape("News about ".$this->entity->title));
    $this->headAnything()->addHtml('<meta property="og:title" content="'.$this->escape($this->entity->title).'">');
    $this->headAnything()->addHtml('<meta property="og:description" content="'.$this->escape($this->entity->description).'">');
    $this->headAnything()->addHtml('<meta property="og:image" content="'.$this->staticFile("images/entities/".$this->entity->picture).'">');
?>
<?
require_once('Model/Facebook/facebook.php');
$config = array(
    'appId' => '706201236078444',
    'secret' => 'fabe992657dcffefd59099502cdf0ce9',
    'allowSignedRequest' => false // optional but should be set to false for non-canvas apps
);
$facebook = new Facebook($config);
?>

<?if ($this->entity->alerts == 0):?>
    <div class="message-container">
        <div>
            <img src="<?=$this->staticFile("images/entities/".$this->entity->picture)?>">
        </div>
        <div>
            <p class="margins">
                No news yet. We've got to wait a little. Either follow this tag or get back later
            </p>
            <a class="big" href="<?=$this->url(array(), "browse", false)?>">browse other tags</a>
        </div>
    </div>
<?else:?>

    <h1 class="info lower"><?=$this->entity->title?></h1>
    <span class="badge-success">статей 180</span>&#160;<span class="badge-info">сегодня 7</span>
    <br/><br/>
    <a class="no-underline" target="_blank" onclick="return !window.open(this.href, 'Facebook', 'width=640,height=300')"
       href="http://www.facebook.com/sharer/sharer.php?u=http://twentytags.com<?=$this->url(array("id"=>$this->entity, Model_Static_Functions::dashString($this->entity->title)=>""), "entity", false)?>">
        <i class="medium lighten-text fa fa-facebook-square"></i>
    </a>
    <a class="no-underline" target="_blank" onclick="return !window.open(this.href, 'Twitter', 'width=640,height=300')"
       href="https://twitter.com/share">
        <i class="medium lighten-text fa fa-twitter-square"></i>
    </a>
    <a class="no-underline" target="_blank" onclick="return !window.open(this.href, 'Google+', 'width=640,height=300')"
       href="https://plus.google.com/share?url=http://twentytags.com<?=$this->url(array("id"=>$this->entity, Model_Static_Functions::dashString($this->entity->title)=>""), "entity", false)?>">
        <i class="medium lighten-text fa fa-google-plus-square"></i>
    </a>
    <p>
        <?=$this->entity->description?>
    </p>
    <?if (!Model_User::isLoggedIn()): ?>
        <?$isLogged = "user-not-logged";?>
        <div class="login-urls" id="login-url-<?=$this->entity?>">
            <?
            $loginUrl = $facebook->getLoginUrl(array(
                "redirect_uri" => WEBSITE_URL.$this->url(array("action"=>"login", "follow"=>$this->entity), "login", false)
            ));
            echo $loginUrl;
            ?>
        </div>

    <?endif?>
    <? $isSaved = Model_Entity::isSaved($this->entity);?>
    <button id="follow-<?=$this->entity?>" class="button-warning f-span4 capitalize to-follow-button <?=$isLogged?> btn-large <?=$isSaved ? " followed":""?>">
        <?=$isSaved ? "Отписаться" : "Подписаться"?>
    </button>
    <?=$this->partial("partials/morealerts.phtml", array("alerts"=>$this->alerts, "mode"=> "entity", "entity" => $this->entity));?>
<?endif?>

<script>
    var now = new Date().getTime();
    $(document).scroll(function () {
        var y = $(this).scrollTop();
        if (y > 800) {
            $('.toTop').fadeIn();
        } else {
            $('.toTop').fadeOut();
        }
        if (y >= ($(document).height() - $(window).height())) {
            if (new Date().getTime() - now > 1000) {
                var offset = $(window).data("offset");
                var url = "<?=$this->url(array('controller' => 'index', 'action' => 'morealerts'), 'default', true)?>";
                var loadUrl = url + '/offset/' + offset + '/entity/' + <?=$this->entity?>;
                loadMore(
                    $("article:last-child"),
                    loadUrl
                );
                now = new Date().getTime();
            }
        }
    });
    $(document).ready (function() {
        $(window).data("offset", "20");
        $("#to-top-button").click(function() {
            $('html, body').animate({ scrollTop: 0 }, 'slow');
        });
    });
    $(".to-follow-button").FollowEntity();
</script>
