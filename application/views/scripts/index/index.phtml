<?$title = $this->mainTag == "What's hot" ? "What's hot":$this->mainTag;?>
<?$this->headTitle("TwentyTags - ".$title)?>
<?
    require_once('Model/Facebook/facebook.php');
    $config = array(
        'appId' => '706201236078444',
        'secret' => 'fabe992657dcffefd59099502cdf0ce9',
        'allowSignedRequest' => false // optional but should be set to false for non-canvas apps
    );
    $facebook = new Facebook($config);
?>

<div class="list-container">
    <div class="list"'>
        <? if (!$this->user) $isLogged = "user-not-logged";?>
        <? foreach ($this->paginator as $item):?>
            <div class="item">
                <div class="item-image">
                    <a href="<?=$this->url(array("id"=>$item, Model_Static_Functions::dashString($item->title)=>""), "entity", false)?>">
                        <img title="<?=$item->title?>" src="<?=$this->staticFile("images/entities/".$item->picture)?>">
                    </a>
                    <div class="item-info">
                        <? if ($item->alerts > 0):?>
                            <span class="item-badge-total" title="<?=$alertCount?> updates total">
                                <?=$item->alerts?>
                            </span>
                        <?endif?>
                        <?if (($todayAlertCount = Model_Alert::retrieveTodayCountByEntity($item)) > 0) :?>
                            <span class="item-badge-today" title="<?=$todayAlertCount?> new articles today">
                                <?=$todayAlertCount?>
                            </span>
                        <? endif ?>
                    </div>
                </div>
                <div class="item-content">
                    <div class="item-title">
                        <a class="red-link" title="<?=$item->title?>" href="<?=$this->url(array("id"=>$item, Model_Static_Functions::dashString($item->title)=>""), "entity", false)?>"><?=$item->title?></a>
                        <? if ($item->link):?>
<!--                            <a class="gray-link" href="<?=$item->link?>">
                                <i title="<?=$item->title?> on the web" class="fa fa-arrow-right"></i>
                            </a>
                            -->
                        <?endif?>
                    </div>
                    <div class="item-tags">
                        <? if ($item->link):?>
                            <a class="red-link" href="<?=$item->link?>">
                                <?=$item->link?>
                            </a><br/>
                        <?endif?>
                        <?$tagged = Model_Tag::retrieveTaggedTagsByEntity($item);?>
                        <? foreach ($tagged as $tag):?>
                            <a class="gray-link link-underline" href="<?=$this->url(array("id"=>$tag, Model_Static_Functions::dashString($tag->value)=>""), "tags", false)?>"><?=$tag->value?></a>&#160;
                        <? endforeach?>
                    </div>
                    <div class="item-description">
                        <?=$item->description?>&#160;&#160;&#160;
                    </div>
                </div>
                <? $isSaved = Model_Entity::isSaved($item);?>
                <div id="item-follow-button-<?=$item?>" class="item-follow-button <?=$isSaved == true ? "make-visible":""?>">
                    <button id="follow-<?=$item?>" class="to-follow-button header-button-small <?=$isLogged?> <?=$isSaved ? " followed":""?>">
                        <? if (!$this->user):?>
                            <div class="login-urls" id="login-url-<?=$item?>">
                                <?
                                    $loginUrl = $facebook->getLoginUrl(array(
                                        "redirect_uri" => WEBSITE_URL.$this->url(array("action"=>"login", "follow"=>$item), "login", false)
                                    ));
                                    echo $loginUrl;
                                ?>
                            </div>
                        <?endif?>
                        <?=$isSaved ? "Unfollow":"Follow"?>
                    </button>
                </div>
            </div>
        <?endforeach?>
    </div>
</div>
<script>
    $(".to-follow-button").FollowEntity();
    /*window.onload = function(){
        var $container = $('.list').masonry({
            itemSelector: '.item',
            columnWidth: '.column-width'
        });
    }*/
</script>